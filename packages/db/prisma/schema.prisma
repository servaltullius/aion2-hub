generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum NoticeSource {
  NOTICE
  UPDATE
}

model NoticeItem {
  id          String      @id @default(cuid())
  source      NoticeSource
  externalId  String
  url         String
  title       String
  publishedAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  snapshots NoticeSnapshot[]
  diffs     NoticeDiff[]

  @@unique([source, externalId])
  @@index([source, publishedAt])
}

model NoticeSnapshot {
  id             String   @id @default(cuid())
  noticeItemId   String
  fetchedAt      DateTime @default(now())
  contentHash    String
  normalizedText String

  noticeItem NoticeItem @relation(fields: [noticeItemId], references: [id], onDelete: Cascade)

  diffsFrom NoticeDiff[] @relation("NoticeDiffFromSnapshot")
  diffsTo   NoticeDiff[] @relation("NoticeDiffToSnapshot")

  @@index([noticeItemId, fetchedAt])
  @@unique([noticeItemId, contentHash])
}

model NoticeDiff {
  id             String   @id @default(cuid())
  noticeItemId   String
  fromSnapshotId String
  toSnapshotId   String
  diffJson       Json
  createdAt      DateTime @default(now())

  noticeItem NoticeItem @relation(fields: [noticeItemId], references: [id], onDelete: Cascade)

  fromSnapshot NoticeSnapshot @relation("NoticeDiffFromSnapshot", fields: [fromSnapshotId], references: [id], onDelete: Cascade)
  toSnapshot   NoticeSnapshot @relation("NoticeDiffToSnapshot", fields: [toSnapshotId], references: [id], onDelete: Cascade)

  @@unique([fromSnapshotId, toSnapshotId])
}
