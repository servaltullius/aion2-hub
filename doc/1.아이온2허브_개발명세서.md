# AION2 HUB 개발 설계서 v0.1

작성일: 2026-01-28 (Asia/Seoul)
문서 목적: **바이브코딩(Codex CLI)로 구현 가능한 수준**까지, “올인원”이되 내부는 모듈(플러그인) 구조로 확장 가능한 **웹 기반 동반자(Companion) 허브**의 상세 설계를 정의합니다.

---

## 1. 배경과 설계 원칙

### 1.1 목표

AION2 플레이를 “더 편하게” 만들어주는 외부 도구를 만들되, 다음 3가지를 동시에 달성합니다.

1. **로컬-퍼스트 숙제/기록 관리**로 “부캐 포함 일일/주간 운영”의 인지 부하 감소
2. **공식 공지/업데이트 노트**를 “변경점(diff) 중심”으로 요약해 패치 대응 비용 감소
3. **레기온(길드)/고정팟 운영 자동화**(일정/모집/출석/리마인드)로 운영 스트레스 감소

### 1.2 절대 금지(Non-goal) — 운영정책 리스크 회피

AION2 운영정책에는 **“비인가 프로그램 사용”**을

* 기술적 보호 조치 무력화 또는 정상 운영 방해가 가능한 프로그램/기기/장치 사용,
* 게임 클라이언트 제약상 정상 이용자가 할 수 없는 행위를 가능하게 하는 프로그램 사용
  등으로 정의하고, 또한 **비인가 프로그램 제작·배포**, **클라이언트/서버 프로그램 수정·개작**을 금지 항목으로 포함합니다. ([NC][1])

따라서 AION2 HUB는 아래를 **기능 요구사항에서 명시적으로 배제**합니다.

* 게임 클라이언트(메모리/프로세스/패킷) 접근, 후킹, 변조, 자동 입력/오토사냥/외부 매크로
* 계정/차단/보호조치 우회, VPN 우회, 하드웨어 차단 회피류
* “정상 이용자가 할 수 없는 행위”를 가능하게 하는 기능

또한 공식 공지 목록에는 “비인가 프로그램 사용 주의 안내” 같은 항목이 실제로 노출되어 있고 ([Aion 2][2]), 운영정책 위반 계정 이용 제한 안내도 반복적으로 공지되는 정황이 있어(예: 특정 차수 공지에서 제재 계정 수·제한 사유 표기) ([Aion 2][3]), **“편의성”을 핑계로 위험 영역을 건드리지 않는 설계**가 핵심입니다.

---

## 2. 제품 정의

### 2.1 제품명(가칭)

**AION2 HUB** — 안전한 올인원 동반자 허브(플래너 + 공지 diff + 레기온 운영)

### 2.2 타깃 사용자(페르소나)

* **P1: 멀티 캐릭 유저**

  * 목표: 숙제 누락 방지, 짧은 시간에 효율적 루틴
* **P2: 레기온장/고정팟 운영자**

  * 목표: 모집/출석/리마인드/분배 기록을 자동화
* **P3: 패치 대응이 중요한 유저**

  * 목표: 공지/업데이트를 “변경점만” 보고 빠르게 대응

### 2.3 MVP 범위

**MVP는 ‘올인원처럼 보이는 3모듈’**로 시작합니다.

* Core(허브 프레임): 모듈 레지스트리, 대시보드, 로컬 저장/백업
* Module A: 숙제 플래너(PWA, 로컬-퍼스트)
* Module B: 공식 공지/업데이트 **diff + 키워드 알림**
* Module C: 레기온 일정/모집/출석 + Discord 연동

> 참고(시장 검증):
>
> * “숙제 체크리스트/캐릭 검색/랭킹”을 제공하는 국내 비공식 사이트가 이미 존재(예: AIONS)하고, 숙제 관리·공유를 주요 기능으로 내세웁니다. ([아이온즈 (AIONS)][4])
> * 아툴(비공식)도 캐릭 검색/랭킹/통계/티어/스펙 비교 등을 한눈에 제공한다고 밝힙니다. ([아툴][5])
>   → 따라서 “숙제/정보 허브” 수요는 검증되어 있고, 우리는 **레기온 운영 자동화 + 공지 diff**로 차별화합니다.

---

## 3. 시스템 아키텍처

### 3.1 상위 구성(논리 아키텍처)

모노레포 기반 **웹 + API + 워커 + 디스코드 봇** 구조.

```
┌──────────────────────────┐
│        Web (Next.js)      │  PWA / Offline / Modules
│  - Dashboard / Modules     │
│  - Planner(Local-first)    │
│  - Notices(Diff viewer)    │
│  - Legion(Admin UI)        │
└─────────────┬─────────────┘
              │ HTTPS (JSON)
┌─────────────▼─────────────┐
│        API (Fastify)       │  Auth / CRUD / RateLimit
│  - Notices endpoints        │
│  - Legion & Events          │
│  - WebPush subscriptions    │
└─────────────┬─────────────┘
              │
     ┌────────▼────────┐
     │ Postgres (DB)    │  Prisma
     └────────┬────────┘
              │
     ┌────────▼────────┐
     │ Redis (Queue)    │  BullMQ
     └────────┬────────┘
              │
┌─────────────▼─────────────┐
│        Worker (Jobs)       │
│  - Fetch notices list       │  공식 공지/업데이트 목록 기반 :contentReference[oaicite:5]{index=5}
│  - Snapshot + Diff           │
│  - Send WebPush/Discord      │
└─────────────┬─────────────┘
              │
┌─────────────▼─────────────┐
│     Discord Bot (discord.js)│
│  - Event announce            │
│  - Signup interactions       │
│  - Attendance marking        │
└────────────────────────────┘
```

### 3.2 배포(물리 아키텍처) 권장안

* Web: Vercel 또는 Docker 기반 배포
* API/Worker/Bot: 단일 VM/컨테이너 호스트(예: Docker Compose → Prod는 Docker Swarm/K8s/단일 서버)
* DB/Redis: 관리형(Postgres/Redis) 또는 같은 호스트(초기)

---

## 4. 데이터 소스 & 수집 정책

### 4.1 공지/업데이트 소스

* 공식 공지 목록: `aion2.plaync.com/.../board/notice/list` ([Aion 2][2])
* 공식 업데이트 목록: `aion2.plaync.com/.../board/update/list` ([Aion 2][6])
* 개별 글은 `view?articleId=...` 형태로 접근되는 패턴이 확인됩니다(목록/검색 결과에 articleId 노출). ([Aion 2][2])

> 구현 주의: 해당 페이지들이 JS 렌더링일 수 있으므로, 수집 모듈은 “HTML 파싱 + (필요 시) Headless 렌더링”을 옵션으로 둡니다.
> **원칙:** 보호조치 우회/비정상 접근 금지, 요청 빈도 최소화(캐시/ETag/If-Modified-Since 활용).

### 4.2 랭킹/캐릭터 정보실(옵션)

* 공식 랭킹/캐릭터 정보실 페이지가 별도로 존재합니다. ([Aion 2][7])
  MVP에서는 **데이터를 긁어오지 않고 “링크 허브”**로 제공(법/운영 안정성).
  추후 필요하면, “사용자가 검색 요청한 1회성” 정도로 제한하고 강력 캐싱.

---

## 5. 모노레포/모듈 구조 설계

### 5.1 레포 구조

```
aion2-hub/
  apps/
    web/                 # Next.js PWA
    api/                 # Fastify API
    worker/              # BullMQ workers
    bot-discord/         # Discord bot
  packages/
    core/                # Module 인터페이스 + registry
    db/                  # Prisma schema + client
    ui/                  # 공용 UI 컴포넌트(선택)
    modules/
      planner/
      notices/
      legion/
      links/             # 옵션(공식 페이지 링크 모듈)
  infra/
    docker-compose.yml   # postgres + redis
  .codex/
    config.toml
    skills/
      SAFE_BOUNDARIES/
      AION2_HUB_CORE/
      ADD_MODULE/
      PRISMA_MIGRATION/
```

### 5.2 모듈 인터페이스(플러그인 계약)

모듈은 `manifest.ts`로 자신을 선언하고, 허브는 registry를 통해 네비/페이지/위젯을 렌더합니다.

**HubModule 핵심 요소**

* `id`, `name`, `description`, `version`
* `permission` (public / user / discord-guild-admin)
* `nav[]` (좌측 메뉴)
* `pages[]` (라우팅)
* `widgets[]` (대시보드 카드)

이 구조의 장점:

* 기능 추가 = `packages/modules/<id>` 폴더 추가 + manifest 등록
* Core UI는 변하지 않고 모듈만 독립 개발 가능
* 나중에 “모듈 스토어(토글)”도 쉽게 붙음

---

## 6. 저장소 설계(로컬-퍼스트 + 서버)

### 6.1 로컬 저장(Planner)

* 기본 저장: **IndexedDB**
* 백업/동기화: JSON 내보내기/가져오기
* (옵션) 로그인 시 서버 동기화 가능(후순위)

**로컬 데이터(예시)**

* `characters[]`
* `taskTemplates[]` (일일/주간/충전형)
* `taskInstances[]` (템플릿이 날짜/주차에 따라 생성된 실행 단위)
* `completions[]` (완료 기록)
* `durations[]` (소요시간 기록: 타임버짓 추천에 사용)

### 6.2 서버 저장(Notice/Legion)

* 공지 스냅샷/diff, 레기온 이벤트/출석/신청 등은 서버가 책임지는 영속 데이터
* DB: Postgres, ORM: Prisma

---

## 7. DB 스키마(초안)

> 아래는 “MVP 완주 가능한 최소 스키마”입니다. (Planner는 로컬 기반이므로 DB에 안 넣어도 됩니다)

### 7.1 핵심 엔터티

* `User` (Discord OAuth 기반 로그인)
* `Character` (유저가 수동 등록)
* `NoticeItem / NoticeSnapshot / NoticeDiff`
* `Legion / LegionMember`
* `Event / EventRole / EventSignup / Attendance`
* `PushSubscription` (Web Push)

### 7.2 Prisma 모델(요약)

(이 문서의 스키마는 이전 대화 초안과 동일 개념이며, 실제 파일에서는 index/unique를 더 다듬습니다.)

* Notice:

  * `NoticeItem`: source, externalId(articleId), url, title, publishedAt
  * `NoticeSnapshot`: fetchedAt, contentHash, normalizedText
  * `NoticeDiff`: fromSnapshotId, toSnapshotId, diffJson

* Legion:

  * `Legion`: discordGuildId(optional), server, faction
  * `Event`: title/kind/startAt/durationMin
  * `EventRole`: roleType(TANK/HEAL/DPS), slots
  * `EventSignup`: 신청(roleType/status)
  * `Attendance`: PRESENT/LATE/NOSHOW

---

## 8. API 설계(REST, JSON)

### 8.1 공통 규칙

* Base: `/api/v1`
* 인증: Discord OAuth(레기온 기능에 필요), Planner는 익명 가능
* 요청/응답 스키마: Zod로 검증 + OpenAPI(선택)
* Rate Limit: IP 기준(특히 공지 조회/검색)

### 8.2 Auth

* `GET /auth/discord/login` → OAuth redirect
* `GET /auth/discord/callback`
* `POST /auth/logout`
* `GET /me`

### 8.3 Notices

* `GET /notices?source=notice|update&page=1&pageSize=20`
* `GET /notices/:id`
* `GET /notices/:id/snapshots` (관리자/디버그)
* `GET /notices/:id/diffs?limit=10`
* `POST /notices/subscriptions`

  * body: `{ keywords: string[], sources: ("notice"|"update")[], delivery: ("webpush"|"discord")[] }`
* `DELETE /notices/subscriptions/:id`

**source 정의 근거**
공식에 공지 목록과 업데이트 목록이 분리되어 존재합니다. ([Aion 2][2])

### 8.4 Legion

* `POST /legions`
* `GET /legions`
* `GET /legions/:id`
* `POST /legions/:id/members/invite`
* `POST /legions/:id/events`
* `GET /legions/:id/events?from=...&to=...`
* `POST /events/:id/roles`
* `POST /events/:id/signup`
* `POST /events/:id/attendance`

---

## 9. Worker(공지 스냅샷/DIFF) 설계

### 9.1 작업 목록

1. **FetchNoticeListJob**

   * 주기: N분(초기엔 10~15분 권장)
   * 대상: 공식 공지 목록 + 공식 업데이트 목록 ([Aion 2][2])
   * 결과: `NoticeItem` upsert

2. **FetchNoticeDetailJob(noticeId)**

   * 개별 글 본문을 가져와 정규화 텍스트 생성
   * `contentHash` 계산하여 스냅샷 변화 감지

3. **DiffNoticeJob(noticeId, fromSnapId, toSnapId)**

   * diff 생성(텍스트 기준)
   * `NoticeDiff` 저장

4. **DeliverNotificationsJob(diffId)**

   * 키워드 매칭 → WebPush/Discord 전송

### 9.2 본문 정규화(Normalization) 규칙

* HTML → text로 변환 시:

  * 스크립트/스타일 제거
  * 공백/줄바꿈 정규화
  * 이미지 alt 텍스트는 옵션
* 해시: `sha256(normalizedText)`

### 9.3 diff 포맷

* `diffJson`에 다음 중 하나 저장

  * (권장) `[{type:"added"|"removed"|"same", text:"..."}]` 형태의 블록 diff
  * 또는 unified diff 문자열

### 9.4 “스킬 매크로” 용어 주의

공식 업데이트 노트 검색 결과에는 “스킬 매크로 추가”와 사용 방식(키 설정에서 단축키 지정, 키를 누르는 동안 실행 등)이 언급됩니다. ([Aion 2][8])
우리 제품의 “매크로”는 오해 소지가 크므로,

* UI/문서에서는 **“로테이션 템플릿/단축키 메모/설정 도우미”** 같은 표현을 쓰고,
* “자동 입력 실행”은 절대 제공하지 않습니다(Non-goal 유지).

---

## 10. Planner 모듈 상세 설계(PWA, 로컬-퍼스트)

### 10.1 주요 화면

* `/m/planner/today`

  * 오늘 할 일(캐릭터별)
  * “30분/60분 루틴 추천” 버튼
* `/m/planner/week`

  * 주간 할 일, 리셋 D-Day
* `/m/planner/templates`

  * 콘텐츠 템플릿 관리(일일/주간/충전형)
* `/m/planner/stats`(옵션)

  * 지난 7/30일 완료율, 평균 소요시간

### 10.2 리셋 규칙

* 일일: 특정 시간(기본값, 사용자 설정)
* 주간: 특정 요일+시간(기본값, 사용자 설정)
* 충전형: `cooldownHours`, `maxStacks` 기반 누적

> 초기 기본값은 “커뮤니티에 알려진 리셋 시간”과 다를 수 있으니, UI에서 **반드시 사용자가 수정 가능**하게 합니다(정책/서버별 차이 대비).

### 10.3 타임버짓 추천 알고리즘(실용형)

* 각 작업에 대해:

  * `estimatedMinutes` = 최근 N회 평균(없으면 기본값)
  * `priorityScore` = 사용자 지정(필수/선호/스킵)
* Knapsack 근사로 “예산 내 최대 가치” 선택

  * MVP는 Greedy(우선순위/효율 기준)로도 충분

### 10.4 백업/이식

* “JSON 내보내기”: 로컬 전체 상태 export
* “JSON 가져오기”: merge or replace 옵션
* (옵션) 암호화 내보내기(PBKDF2 + AES) — 개인정보 보호

---

## 11. Legion(레기온) + Discord Bot 설계

### 11.1 Discord 권한 모델

* `/setup` 명령: 길드(서버)에서 봇 초기 연결
* 길드 관리자만 레기온 생성/연결 가능
* 이벤트 생성/수정은 레기온 ADMIN 권한만

### 11.2 봇 기능(명령 & 인터랙션)

* `/event create`

  * 제목/종류/시간/역할 슬롯 입력
  * 생성 시 모집 메시지 게시 + 버튼(탱/힐/딜 신청)
* `/event list`

  * 다가오는 이벤트 목록
* 버튼 인터랙션

  * roleType 선택 → 서버 API로 Signup upsert
  * 슬롯 초과 시 WAITLIST
* 리마인드

  * 이벤트 시작 전 X분(설정) 알림
* 출석

  * 이벤트 시작 후 체크 버튼(또는 웹에서 일괄)

### 11.3 웹 대시보드(레기온)

* 캘린더/리스트 뷰
* 역할별 신청 현황
* 출석 통계(월별 노쇼율 등)
* 분배 기록(옵션): “기록만” 제공(자동 분배/조작 금지)

---

## 12. Frontend UI/UX 가이드

### 12.1 레이아웃

* 좌측: 모듈 네비(모듈별 메뉴)
* 상단: 캐릭터 선택(Planner), 레기온 선택(Legion), 검색
* 메인: 모듈 페이지

### 12.2 대시보드 위젯

* Planner: “오늘 남은 숙제” 요약 카드
* Notices: “최근 변경된 공지 3개” 카드
* Legion: “다가오는 이벤트” 카드

### 12.3 PWA 요구사항

* install 가능(Manifest)
* 오프라인에서도 Planner 사용 가능(캐시 전략: static assets + indexedDB)
* Web Push(옵션): Notices/Legion 알림

---

## 13. 보안/개인정보 설계

### 13.1 데이터 분류

* 로컬만: 숙제/플레이 기록(기본)
* 서버: 공지 스냅샷, 레기온 운영 데이터, 계정(Discord id), WebPush subscription

### 13.2 보안 체크리스트

* CSP(Content-Security-Policy)
* 입력값 검증(Zod)
* CSRF 방어(세션 쿠키 사용 시)
* Rate limiting(특히 공지 관련 endpoint)
* 민감정보(토큰/키) Vault/환경변수 관리
* 로그에 토큰/개인정보 마스킹

---

## 14. 운영(Observability) 설계

* 로그: 구조화(JSON)
* 오류 추적: Sentry(옵션)
* 메트릭: Prometheus/OpenTelemetry(옵션)
* DB 백업: 일 1회 + WAL(관리형이면 기본 제공)

---

## 15. 테스트 전략

### 15.1 단위 테스트(Unit)

* Planner 리셋/집계/타임버짓 로직
* diff 생성 함수(고정 입력→고정 출력)

### 15.2 통합 테스트(Integration)

* API CRUD(레기온/이벤트/신청)
* Worker: 목록→스냅샷→diff 파이프라인(목업 HTML fixture)

### 15.3 E2E

* 주요 플로우:

  * Planner 체크/리셋
  * 공지 diff 화면 렌더
  * 레기온 이벤트 생성→디스코드 신청 반영

---

## 16. Codex CLI 기반 개발 운영 규칙

Codex CLI는 `--ask-for-approval`로 명령 실행 전 승인 정책을 제어할 수 있고 ([OpenAI 개발자 포털][9]), 설정은 기본적으로 `~/.codex/config.toml`에 저장되며 프로젝트별로 `.codex/config.toml`을 둘 수 있습니다. 또한 설정 우선순위(CLI 플래그 → profile → 프로젝트 config → 유저 config …)가 문서화되어 있습니다. ([OpenAI 개발자 포털][10])
고급 설정에서는 profile로 모델/승인정책 등을 묶어 전환하는 예시도 제공됩니다. ([OpenAI 개발자 포털][11])

### 16.1 추천 Codex 실행 모드(안전)

* 기본: **workspace-write + on-request**

  * 문서 예시로도 `codex --sandbox workspace-write --ask-for-approval on-request` 조합이 안내됩니다. ([OpenAI 개발자 포털][12])

### 16.2 `.codex/config.toml` 예시

```toml
approval_policy = "on-request"
sandbox_mode    = "workspace-write"

[profiles.review]
approval_policy = "on-request"
sandbox_mode    = "read-only"
```

(설정 계층/경로는 Config basics에 명시) ([OpenAI 개발자 포털][10])

### 16.3 Skills(반복 작업 표준화)

* `SAFE_BOUNDARIES`: 비인가 프로그램/클라 수정/매크로/우회 기능 금지(항상 적용)
* `AION2_HUB_CORE`: 모듈 레지스트리/라우팅 규칙 강제
* `ADD_MODULE`: 모듈 스캐폴딩 자동화
* `PRISMA_MIGRATION`: 스키마 변경→마이그레이션→generate 자동화

---

## 17. 단계별 구현 순서(권장)

1. **Core + Modules registry + 대시보드**
2. Planner 모듈(로컬 저장/리셋/추천)
3. API/DB/Redis 세팅 + Worker skeleton
4. Notices 수집 → Snapshot → Diff → Web UI
5. Discord bot → Legion 이벤트/신청/출석
6. Web Push/Discord 알림 정교화
7. (확장) 지도/수집/경제/세팅 비교 모듈

---

## 18. 리스크 & 대응

1. **공식 페이지 구조 변경**

   * 대응: NoticeSource 추상화(HTML 파서/Headless 파서), fixture 기반 테스트
2. **법/운영정책 리스크**

   * 대응: Non-goal 명문화, “클라 접근/자동화” 코드 리뷰 시 즉시 거부(스킬 강제)
   * 근거: 운영정책상 비인가 프로그램/제작·배포/클라 수정·개작 금지. ([NC][1])
3. **과도한 트래픽**

   * 대응: 주기 조절, 캐싱, 변경 감지 기반 fetch 최소화

---

## 부록 A. 공식 링크(코드에서만 사용)

> 아래는 개발 시 “설정 파일에 넣을 수 있는” 수준으로만 제공합니다(문서 본문에는 원문 URL을 코드로만 표기).

```txt
공지 목록: https://aion2.plaync.com/ko-kr/board/notice/list
업데이트 목록: https://aion2.plaync.com/ko-kr/board/update/list
랭킹: https://aion2.plaync.com/ko-kr/ranking/index
캐릭터 정보실: https://aion2.plaync.com/ko-kr/characters/index
운영정책: https://www.plaync.com/policy/operation/aion2
```

---

원하시면, 이 설계서를 기반으로 다음 2개도 바로 만들어 드릴게요(추가 질문 없이 진행 가능):

1. **와이어프레임(페이지별 UI 구성) + 컴포넌트 목록**
2. **첫 작업 이슈 30개(우선순위/완료 정의/테스트 기준 포함)** + Codex CLI에 넣을 “작업 프롬프트 세트”

[1]: https://www.plaync.com/policy/operation/aion2 "
        
            
            

            
                Operation Policy
            
        
    "
[2]: https://aion2.plaync.com/ko-kr/board/notice/list?utm_source=chatgpt.com "공지 : AION2-NCSOFT"
[3]: https://aion2.plaync.com/ko-kr/board/notice/view?articleId=6974bd7336e37972f4a967fa&utm_source=chatgpt.com "[안내] 운영정책 위반 계정들에 대한 게임 이용제한 안내 [70차]"
[4]: https://aions.kr/?utm_source=chatgpt.com "아이온즈 (AIONS) - 아이온2 숙제 관리 · 캐릭터 검색 · 전투력 랭킹"
[5]: https://www.aion2tool.com/?utm_source=chatgpt.com "아툴 - 아이온2 정보 검색·랭킹 사이트"
[6]: https://aion2.plaync.com/ko-kr/board/update/list?utm_source=chatgpt.com "업데이트 : AION2-NCSOFT"
[7]: https://aion2.plaync.com/ko-kr/ranking/index?utm_source=chatgpt.com "랭킹 - 캐릭터 정보실 : AION2-NCSOFT"
[8]: https://aion2.plaync.com/ko-kr/board/update/view?articleId=69791238ba0dc1026f956b24&utm_source=chatgpt.com "[안내] 1/28(수) 업데이트 노트 - aion2 - NCSOFT"
[9]: https://developers.openai.com/codex/cli/reference/ "Command line options"
[10]: https://developers.openai.com/codex/config-basic/ "Config basics"
[11]: https://developers.openai.com/codex/config-advanced/ "Advanced Configuration"
[12]: https://developers.openai.com/codex/security/ "Security"
